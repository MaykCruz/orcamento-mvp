<!DOCTYPE html>
<html lang="pt-br" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EasyFlow - Novo Orçamento</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="icon" type="image/svg+xml" th:href="@{/favicon.svg}">
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        body { font-family: 'Inter', sans-serif; }
        input:focus, select:focus, textarea:focus { outline: none; }

        /* Estilos do Dropdown */
        .dropdown-content {
            position: absolute; z-index: 50; max-height: 200px; overflow-y: auto; width: 100%;
            background: white; border: 1px solid #e2e8f0; border-radius: 0.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); display: none;
        }
        .dropdown-content.show { display: block; }
        .dropdown-item { padding: 0.5rem 0.75rem; cursor: pointer; transition: background-color 0.2s; }
        .dropdown-item:hover { background-color: #f1f5f9; }
    </style>
</head>
<body class="bg-slate-50 flex h-screen overflow-hidden">

<aside th:replace="~{fragments/sidebar :: sidebar('novoOrcamento')}"></aside>

<div class="flex-1 flex flex-col overflow-y-auto">
    <main class="p-8 max-w-6xl mx-auto w-full">

        <div class="flex justify-between items-center mb-8">
            <h1 class="text-2xl font-bold text-slate-900" th:text="${modoVisualizacao} ? 'Visualizar Orçamento' : 'Novo Orçamento'"></h1>
            <a th:href="@{/orcamentos/historico}" class="text-slate-500 hover:text-blue-600 text-sm font-medium flex items-center">
                <i data-lucide="arrow-left" class="w-4 h-4 mr-1"></i> Voltar
            </a>
        </div>

        <div th:if="${mensagemSucesso}" class="mb-6 p-4 rounded-lg bg-green-50 border border-green-200 text-green-700 flex items-center">
            <i data-lucide="check-circle" class="w-5 h-5 mr-2"></i> <span th:text="${mensagemSucesso}"></span>
        </div>
        <div th:if="${mensagemErro}" class="mb-6 p-4 rounded-lg bg-red-50 border border-red-200 text-red-700 flex items-center">
            <i data-lucide="alert-circle" class="w-5 h-5 mr-2"></i> <span th:text="${mensagemErro}"></span>
        </div>

        <form th:action="@{/orcamentos/novo}" th:object="${orcamentoFormDTO}" method="post" id="form-orcamento">

            <fieldset th:disabled="${modoVisualizacao}" class="space-y-6 border-0 p-0 m-0">

                <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">

                        <div class="relative">
                            <label class="block text-sm font-medium text-slate-700 mb-1">Cliente</label>
                            <input type="text" id="cliente-search"
                                   class="w-full rounded-lg border-slate-300 shadow-sm focus:border-blue-500 focus:ring-1 focus:ring-blue-500 py-2 px-3 border bg-white"
                                   placeholder="Buscar cliente..." autocomplete="off" />

                            <div class="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none top-6">
                                <i data-lucide="chevrons-up-down" class="h-4 w-4 text-slate-400"></i>
                            </div>

                            <input type="hidden" th:field="*{clienteId}" id="clienteIdHidden" />
                            <div id="cliente-dropdown" class="dropdown-content mt-1"></div>

                            <select id="cliente-source" class="hidden">
                                <option value="">-- Selecione --</option>
                                <option th:each="cliente : ${clientes}" th:value="${cliente.id}" th:text="${cliente.nome}"></option>
                            </select>
                            <p class="mt-1 text-sm text-red-600" th:if="${#fields.hasErrors('clienteId')}" th:errors="*{clienteId}"></p>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">Desconto Global</label>

                            <input type="text" id="desconto-visual"
                                   class="w-full rounded-lg border-slate-300 shadow-sm focus:border-blue-500 focus:ring-1 focus:ring-blue-500 py-2 px-3 border"
                                   placeholder="R$ 0,00" />

                            <input type="hidden" th:field="*{desconto}" id="desconto-real" />
                        </div>

                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-slate-700 mb-1">Observações</label>
                            <textarea th:field="*{obs}" id="obs" rows="2" class="w-full rounded-lg border-slate-300 shadow-sm focus:border-blue-500 focus:ring-1 focus:ring-blue-500 py-2 px-3 border"></textarea>
                        </div>
                    </div>
                </div>

                <div class="bg-slate-100 rounded-xl border border-slate-200 p-6" th:if="${!modoVisualizacao}">
                    <h3 class="text-sm font-bold text-slate-700 uppercase tracking-wide mb-4">Adicionar Item</h3>
                    <div class="grid grid-cols-1 md:grid-cols-12 gap-4 items-end">

                        <div class="md:col-span-4 relative">
                            <label class="block text-xs font-medium text-slate-500 mb-1">Produto/Serviço</label>
                            <input type="text" id="produto-search"
                                   class="w-full rounded-lg border-slate-300 shadow-sm focus:border-blue-500 py-2 px-3 border bg-white"
                                   placeholder="Buscar item..." autocomplete="off" />
                            <div class="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none top-6">
                                <i data-lucide="chevrons-up-down" class="h-4 w-4 text-slate-400"></i>
                            </div>
                            <input type="hidden" id="selected-produto-id" />
                            <div id="produto-dropdown" class="dropdown-content mt-1"></div>
                            <select id="produto-source" class="hidden">
                                <option value="">-- Selecione --</option>
                                <option th:each="produto : ${produtos}" th:value="${produto.id}" th:text="${produto.descricao}" th:data-preco="${produto.preco}" th:data-editavel="${produto.precoEditavel}"></option>
                            </select>
                        </div>

                        <div class="md:col-span-2">
                            <label class="block text-xs font-medium text-slate-500 mb-1">Preço Unit.</label>
                            <input type="text" id="item-preco" class="w-full rounded-lg border-slate-300 py-2 px-3 border bg-gray-50" placeholder="R$ 0,00" readonly />
                        </div>

                        <div class="md:col-span-2">
                            <label class="block text-xs font-medium text-slate-500 mb-1">Qtd</label>
                            <input type="number" id="item-qtd" value="1" min="1" class="w-full rounded-lg border-slate-300 py-2 px-3 border" />
                        </div>

                        <div class="md:col-span-2">
                            <label class="block text-xs font-medium text-slate-500 mb-1">Desconto</label>
                            <input type="text" id="item-desconto" class="w-full rounded-lg border-slate-300 py-2 px-3 border" placeholder="R$ 0,00" />
                        </div>

                        <div class="md:col-span-2">
                            <button type="button" id="btn-add-item" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-lg shadow-sm transition-colors flex justify-center items-center">
                                <i data-lucide="plus" class="w-4 h-4 mr-1"></i> Add
                            </button>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                    <table id="itens-orcamento-table" class="min-w-full divide-y divide-slate-200">
                        <thead class="bg-slate-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-semibold text-slate-500 uppercase">Descrição</th>
                            <th class="px-6 py-3 text-left text-xs font-semibold text-slate-500 uppercase whitespace-nowrap">Preço Unit.</th>
                            <th class="px-6 py-3 text-left text-xs font-semibold text-slate-500 uppercase">Qtd</th>
                            <th class="px-6 py-3 text-left text-xs font-semibold text-slate-500 uppercase whitespace-nowrap">Desconto</th>
                            <th class="px-6 py-3 text-left text-xs font-semibold text-slate-500 uppercase whitespace-nowrap">Subtotal</th>

                            <th class="px-6 py-3 text-center text-xs font-semibold text-slate-500 uppercase">Ação</th>
                        </tr>
                        </thead>
                        <tbody id="itens-tbody" class="divide-y divide-slate-200">
                        <tr th:each="item, stat : *{itens}" th:attr="data-item-index=${stat.index}">
                            <td class="px-6 py-4 text-sm text-slate-900" th:text="${item.produtoDescricaoAux}">Produto</td>
                            <td class="px-6 py-4 text-sm text-slate-500 whitespace-nowrap" th:text="'R$ ' + ${#numbers.formatDecimal(item.precoUnitario, 1, 2, 'COMMA')}">100,00</td>
                            <td class="px-6 py-4 text-sm text-slate-500" th:text="${item.qtd}">1</td>
                            <td class="px-6 py-4 text-sm text-slate-500 whitespace-nowrap" th:text="'R$ ' + ${#numbers.formatDecimal(item.desconto, 1, 2, 'COMMA')}">0,00</td>
                            <td class="px-6 py-4 text-sm font-medium text-slate-900 whitespace-nowrap" th:text="'R$ ' + ${#numbers.formatDecimal((item.precoUnitario * item.qtd) - item.desconto, 1, 2, 'COMMA')}">100,00</td>

                            <td class="px-6 py-4 text-center">
                                <button type="button" class="btn-remover text-red-500 hover:text-red-700 font-medium text-sm" th:if="${!modoVisualizacao}">Remover</button>
                                <input type="hidden" th:name="|itens[${stat.index}].produtoId|" th:value="${item.produtoId}" />
                                <input type="hidden" th:name="|itens[${stat.index}].precoUnitario|" th:value="${item.precoUnitario}" />
                                <input type="hidden" th:name="|itens[${stat.index}].qtd|" th:value="${item.qtd}" />
                                <input type="hidden" th:name="|itens[${stat.index}].desconto|" th:value="${item.desconto}" />
                                <input type="hidden" th:name="|itens[${stat.index}].produtoDescricaoAux|" th:value="${item.produtoDescricaoAux}" />
                            </td>
                        </tr>
                        </tbody>
                    </table>
                </div>

                <div class="flex justify-end items-center pt-4">
                    <div class="text-right">
                        <p class="text-sm text-slate-500">Total Final</p>
                        <p class="text-3xl font-bold text-slate-900" id="total-orcamento">R$ 0,00</p>
                    </div>
                </div>

                <div class="flex justify-end pt-6 border-t border-slate-200" th:if="${!modoVisualizacao}">
                    <button type="submit" class="px-6 py-3 text-base font-medium text-white bg-blue-600 rounded-lg hover:bg-blue-700 shadow-md flex items-center">
                        <i data-lucide="check" class="w-5 h-5 mr-2"></i> Salvar Orçamento
                    </button>
                </div>

            </fieldset>
        </form>
    </main>
</div>

<script th:inline="javascript">
    /*<![CDATA[*/
    document.addEventListener("DOMContentLoaded", () => {
        lucide.createIcons();

        // --- FUNÇÕES AUXILIARES DE MOEDA ---

        // Formata número float para moeda (1200.50 -> "R$ 1.200,50")
        const formatCurrency = (value) => {
            if (value === "" || value === undefined) return "";
            return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(value);
        };

        // Converte string moeda para float ("R$ 1.200,50" -> 1200.50)
        const parseMoney = (value) => {
            if (!value) return 0.0;
            // Remove tudo que não é dígito ou vírgula
            let cleanValue = value.replace(/[^\d,]/g, '').replace(',', '.');
            return parseFloat(cleanValue) || 0.0;
        };

        // Aplica máscara enquanto digita
        const applyMask = (input) => {
            let value = input.value.replace(/\D/g, ""); // Só números
            value = (value / 100).toFixed(2) + ""; // Divide por 100
            value = value.replace(".", ","); // Troca ponto por vírgula
            value = value.replace(/(\d)(?=(\d{3})+(?!\d))/g, "$1."); // Separador de milhar
            input.value = "R$ " + value;
        };

        // Configura eventos de máscara em inputs
        const setupCurrencyInput = (id) => {
            const input = document.getElementById(id);
            if(input) {
                input.addEventListener('input', () => applyMask(input));
                // Inicializa com zero se vazio
                if(!input.value) input.value = "R$ 0,00";
            }
        };

        // --- INICIALIZAÇÃO ---
        setupCurrencyInput('desconto-visual');
        setupCurrencyInput('item-preco');
        setupCurrencyInput('item-desconto');

        // Bloqueio de Enter
        const form = document.getElementById('form-orcamento');
        form.addEventListener('keydown', function(event) {
            if (event.key === 'Enter' && event.target.tagName !== 'TEXTAREA') {
                event.preventDefault();
                return false;
            }
        });

        // Lógica de sincronização do Desconto Global (Visual -> Real)
        const descontoVisual = document.getElementById('desconto-visual');
        const descontoReal = document.getElementById('desconto-real');

        // Se vier valor do Java (edição), preenche o visual
        if (descontoReal.value) {
            descontoVisual.value = formatCurrency(descontoReal.value);
        }

        // Quando digita no visual, atualiza o hidden
        descontoVisual.addEventListener('input', () => {
            descontoReal.value = parseMoney(descontoVisual.value);
            calcularTotalGeral(); // Recalcula o total
        });


        // --- AUTOCOMPLETE (Igual ao anterior, com ajuste para Preço) ---
        function setupAutocomplete(searchId, hiddenId, dropdownId, sourceId, onSelectCallback) {
            const searchInput = document.getElementById(searchId);
            const hiddenInput = document.getElementById(hiddenId);
            const dropdown = document.getElementById(dropdownId);
            const sourceSelect = document.getElementById(sourceId);

            if (!searchInput || !sourceSelect) return;

            let items = [];
            Array.from(sourceSelect.options).forEach(opt => {
                if (opt.value) {
                    items.push({
                        id: opt.value,
                        text: opt.text,
                        preco: opt.getAttribute('data-preco'),
                        editavel: opt.getAttribute('data-editavel')
                    });
                }
            });
            items.sort((a, b) => a.text.localeCompare(b.text));

            if (hiddenInput && hiddenInput.value) {
                const selected = items.find(i => i.id === hiddenInput.value);
                if (selected) searchInput.value = selected.text;
            }

            function renderOptions(filter = "") {
                dropdown.innerHTML = '';
                const filtered = items.filter(i => i.text.toLowerCase().includes(filter.toLowerCase()));
                if (filtered.length === 0) {
                    dropdown.innerHTML = '<div class="p-3 text-sm text-slate-500">Nenhum resultado.</div>';
                } else {
                    filtered.forEach((item, index) => {
                        const div = document.createElement('div');
                        div.className = 'dropdown-item text-sm text-slate-700';
                        div.textContent = item.text;
                        div.onclick = () => selectItem(item);
                        dropdown.appendChild(div);
                    });
                }
                dropdown.classList.add('show');
            }

            function selectItem(item) {
                searchInput.value = item.text;
                if(hiddenInput) hiddenInput.value = item.id;
                dropdown.classList.remove('show');
                if (onSelectCallback) onSelectCallback(item);
            }

            searchInput.addEventListener('input', (e) => renderOptions(e.target.value));
            searchInput.addEventListener('focus', () => renderOptions(searchInput.value));
            searchInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    const firstOption = dropdown.querySelector('.dropdown-item');
                    if (firstOption) firstOption.click();
                }
            });
            document.addEventListener('click', (e) => {
                if (!searchInput.contains(e.target) && !dropdown.contains(e.target)) dropdown.classList.remove('show');
            });
        }

        setupAutocomplete('cliente-search', 'clienteIdHidden', 'cliente-dropdown', 'cliente-source', null);

        // Configuração do Produto
        const itemPrecoInput = document.getElementById("item-preco");
        const itemQtdInput = document.getElementById("item-qtd");

        setupAutocomplete('produto-search', 'selected-produto-id', 'produto-dropdown', 'produto-source', (item) => {
            if (itemPrecoInput) {
                // Formata o preço vindo do banco (ex: 100.00 -> R$ 100,00)
                itemPrecoInput.value = formatCurrency(item.preco);

                itemPrecoInput.readOnly = (item.editavel !== "true");
                if (item.editavel !== "true") {
                    itemPrecoInput.classList.add("bg-gray-50");
                    if(itemQtdInput) itemQtdInput.focus();
                } else {
                    itemPrecoInput.classList.remove("bg-gray-50");
                    itemPrecoInput.focus();
                }
            }
        });

        // --- TABELA E TOTAIS ---
        const itemDescontoInput = document.getElementById("item-desconto");
        const btnAddItem = document.getElementById("btn-add-item");
        const itensTbody = document.getElementById("itens-tbody");
        const totalSpan = document.getElementById("total-orcamento");
        const produtoSearchInput = document.getElementById("produto-search");
        const selectedProdutoIdInput = document.getElementById("selected-produto-id");

        function renumerarIndices() {
            const linhas = itensTbody.querySelectorAll("tr");
            linhas.forEach((tr, index) => {
                const inputs = tr.querySelectorAll('input[type="hidden"]');
                inputs.forEach(input => {
                    const name = input.getAttribute("name");
                    const newName = name.replace(/itens\[\d+\]/, `itens[${index}]`);
                    input.setAttribute("name", newName);
                });
            });
        }

        if(btnAddItem) {
            btnAddItem.addEventListener("click", () => {
                const produtoId = selectedProdutoIdInput.value;
                const produtoDesc = produtoSearchInput.value;

                if (!produtoId) { alert("Selecione um produto na lista."); return; }

                // Usa parseMoney para ler os valores formatados
                const precoUnit = parseMoney(itemPrecoInput.value);
                const qtd = parseInt(itemQtdInput.value);
                const descItem = parseMoney(itemDescontoInput.value);
                const subtotal = (precoUnit * qtd) - descItem;

                const tr = document.createElement("tr");
                tr.innerHTML = `
                    <td class="px-6 py-4 text-sm text-slate-900">${produtoDesc}</td>
                    <td class="px-6 py-4 text-sm text-slate-500 whitespace-nowrap">${formatCurrency(precoUnit)}</td>
                    <td class="px-6 py-4 text-sm text-slate-500">${qtd}</td>
                    <td class="px-6 py-4 text-sm text-slate-500 whitespace-nowrap">${formatCurrency(descItem)}</td>
                    <td class="px-6 py-4 text-sm font-medium text-slate-900 whitespace-nowrap">${formatCurrency(subtotal)}</td>
                    <td class="px-6 py-4 text-right">
                        <button type="button" class="btn-remover text-red-500 hover:text-red-700 font-medium text-sm">Remover</button>
                        <input type="hidden" name="itens[0].produtoId" value="${produtoId}" />
                        <input type="hidden" name="itens[0].precoUnitario" value="${precoUnit}" />
                        <input type="hidden" name="itens[0].qtd" value="${qtd}" />
                        <input type="hidden" name="itens[0].desconto" value="${descItem}" />
                        <input type="hidden" name="itens[0].produtoDescricaoAux" value="${produtoDesc}" />
                    </td>`;

                itensTbody.appendChild(tr);
                resetAddPanel();
                renumerarIndices();
                calcularTotalGeral();
            });
        }

        if(itensTbody) {
            itensTbody.addEventListener("click", (e) => {
                if (e.target.classList.contains("btn-remover")) {
                    e.target.closest("tr").remove();
                    renumerarIndices();
                    calcularTotalGeral();
                }
            });
        }

        function calcularTotalGeral() {
            let subtotalGeral = 0;
            const todosPrecos = document.querySelectorAll(`input[name$=".precoUnitario"]`);
            const todasQtds = document.querySelectorAll(`input[name$=".qtd"]`);
            const todosDescs = document.querySelectorAll(`input[name$=".desconto"]`);

            for(let i = 0; i < todosPrecos.length; i++) {
                subtotalGeral += (parseFloat(todosPrecos[i].value) * parseInt(todasQtds[i].value)) - (parseFloat(todosDescs[i].value) || 0);
            }

            // Lê o valor real do hidden
            const descontoTotal = parseFloat(descontoReal.value) || 0;
            const totalFinal = subtotalGeral - descontoTotal;

            if(totalSpan) totalSpan.textContent = formatCurrency(totalFinal);
        }

        function resetAddPanel() {
            produtoSearchInput.value = "";
            selectedProdutoIdInput.value = "";
            itemPrecoInput.value = "R$ 0,00";
            itemPrecoInput.readOnly = true;
            itemPrecoInput.classList.add("bg-gray-50");
            itemQtdInput.value = "1";
            itemDescontoInput.value = "R$ 0,00";
            produtoSearchInput.focus();
        }

        calcularTotalGeral();
    });
    /*]]>*/
</script>
</body>
</html>