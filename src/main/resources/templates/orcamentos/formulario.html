<!DOCTYPE html>
<html lang="pt-br" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Novo Orçamento</title>
    <style>
        /* CORREÇÃO 1: Centralizar a página na tela */
        body {
            font-family: Arial, sans-serif;
            margin: 20px auto; /* auto centraliza horizontalmente */
            max-width: 1000px;
        }

        /* CORREÇÃO 2: O form vira apenas um container normal */
        form {
            display: block;
            width: 100%;
        }

        /* CORREÇÃO 3: O GRID agora acontece DENTRO do fieldset */
        fieldset {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;

            /* Remove as bordas padrão do fieldset para ficar invisível */
            border: none;
            padding: 0;
            margin: 0;
            min-width: 0;
            width: 100%;
        }

        div { display: flex; flex-direction: column; }

        label { margin-bottom: 5px; font-weight: bold; }

        input[type=text], input[type=number], select, textarea { padding: 8px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }

        textarea { resize: vertical; min-height: 80px; }

        .full-width { grid-column: 1 / -1; }

        .btn-salvar { background-color: #007bff; color: white; padding: 10px 15px; border: none; border-radius: 4px; cursor: pointer; }
        .btn-voltar { text-decoration: none; color: #555; display: inline-block; margin-top: 10px;}

        .msg-sucesso { color: green; border: 1px solid green; padding: 10px; margin-bottom: 10px; }
        .msg-erro { color: red; border: 1px solid red; padding: 10px; margin-bottom: 10px; }
        .error-message { color: red; font-size: 0.9em; margin-top: 2px; }

        #itens-orcamento-table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        #itens-orcamento-table th, #itens-orcamento-table td { border: 1px solid #ddd; padding: 8px; }
        #itens-orcamento-table th { background-color: #f2f2f2; }
        #itens-orcamento-table .btn-remover { background-color: #dc3545; color: white; border: none; padding: 5px; cursor: pointer; }

        .add-item-panel { display: grid; grid-template-columns: 3fr 1fr 1fr 1fr 1fr; gap: 10px; align-items: flex-end; padding: 10px; background-color: #f9f9f9; border-radius: 4px; }
        .total-panel { text-align: right; font-size: 1.2em; font-weight: bold; margin-top: 15px; }
    </style>
</head>
<body>

<h1>Novo Orçamento</h1>

<div th:if="${mensagemSucesso}" class="msg-sucesso" th:text="${mensagemSucesso}"></div>
<div th:if="${mensagemErro}" class="msg-erro" th:text="${mensagemErro}"></div>

<form th:action="@{/orcamentos/novo}" th:object="${orcamentoFormDTO}" method="post">

    <fieldset th:disabled="${modoVisualizacao}">

        <div th:if="${#fields.hasErrors('*')}" class="msg-erro full-width">
            <p>Corrija os seguintes erros:</p>
            <ul>
                <li th:each="err : ${#fields.errors('*')}" th:text="${err}"></li>
            </ul>
        </div>

        <div class="full-width">
            <h2>1. Dados Gerais</h2>
        </div>

        <div>
            <label for="clienteId">Cliente:</label>
            <select th:field="*{clienteId}" id="clienteId">
                <option value="">-- Selecione um Cliente --</option>
                <option th:each="cliente : ${clientes}"
                        th:value="${cliente.id}"
                        th:text="${cliente.nome}">
                    Nome do Cliente
                </option>
            </select>
            <span class="error-message" th:if="${#fields.hasErrors('clienteId')}" th:errors="*{clienteId}"></span>
        </div>

        <div>
            <label for="desconto">Desconto Total (R$):</label>
            <input type="number" th:field="*{desconto}" id="desconto" step="0.01" min="0" value="0" />
        </div>

        <div class="full-width">
            <label for="obs">Observações:</label>
            <textarea th:field="*{obs}" id="obs"></textarea>
        </div>

        <div class="full-width">
            <h2>2. Itens do Orçamento</h2>
        </div>

        <div class="full-width add-item-panel">
            <div>
                <label>Produto/Serviço:</label>
                <select id="produto-select">
                    <option value="">-- Selecione um Item --</option>
                    <option th:each="produto : ${produtos}"
                            th:value="${produto.id}"
                            th:text="${produto.descricao}"
                            th:data-preco="${produto.preco}"
                            th:data-editavel="${produto.precoEditavel}">
                        Descrição do Produto
                    </option>
                </select>
            </div>
            <div>
                <label for="item-preco">Preço Unit. (R$):</label>
                <input type="number" id="item-preco" step="0.01" min="0" />
            </div>
            <div>
                <label for="item-qtd">Qtd:</label>
                <input type="number" id="item-qtd" value="1" min="1" />
            </div>
            <div>
                <label for="item-desconto">Desconto (R$):</label>
                <input type="number" id="item-desconto" step="0.01" min="0" value="0" />
            </div>
            <div>
                <button type="button" id="btn-add-item" class="btn-salvar">Adicionar Item</button>
            </div>
        </div>

        <div class="full-width">
            <table id="itens-orcamento-table">
                <thead>
                <tr>
                    <th>Descrição</th>
                    <th>Preço Unit.</th>
                    <th>Qtd.</th>
                    <th>Desconto (R$)</th>
                    <th>Subtotal</th>
                    <th>Ação</th>
                </tr>
                </thead>
                <tbody id="itens-tbody">
                <tr th:each="item, stat : *{itens}" th:attr="data-item-index=${stat.index}">
                    <td th:text="${item.produtoDescricaoAux}">Produto X</td>
                    <td th:text="'R$ ' + ${#numbers.formatDecimal(item.precoUnitario, 1, 2)}">R$ 100.00</td>
                    <td th:text="${item.qtd}">1</td>
                    <td th:text="'R$ ' + ${#numbers.formatDecimal(item.desconto, 1, 2)}">R$ 0.00</td>
                    <td th:text="'R$ ' + ${#numbers.formatDecimal((item.precoUnitario * item.qtd) - item.desconto, 1, 2)}">R$ 100.00</td>
                    <td>
                        <button type="button" class="btn-remover">Remover</button>
                        <input type="hidden" th:name="|itens[${stat.index}].produtoId|" th:value="${item.produtoId}" />
                        <input type="hidden" th:name="|itens[${stat.index}].precoUnitario|" th:value="${item.precoUnitario}" />
                        <input type="hidden" th:name="|itens[${stat.index}].qtd|" th:value="${item.qtd}" />
                        <input type="hidden" th:name="|itens[${stat.index}].desconto|" th:value="${item.desconto}" />
                        <input type="hidden" th:name="|itens[${stat.index}].produtoDescricaoAux|" th:value="${item.produtoDescricaoAux}" />
                    </td>
                </tr>
                </tbody>
            </table>
        </div>

        <div class="full-width total-panel">
            Total: <span id="total-orcamento">R$ 0,00</span>
        </div>

        <div class="full-width" th:if="${!modoVisualizacao}">
            <button type="submit" class="btn-salvar">Salvar Orçamento</button>
        </div>

    </fieldset>

    <div style="margin-top: 15px;">
        <a th:href="@{/orcamentos/historico}" class="btn-voltar">Voltar</a>
    </div>

</form>

<script th:inline="javascript">
    /*<![CDATA[*/
    document.addEventListener("DOMContentLoaded", () => {

        const produtoSelect = document.getElementById("produto-select");
        const itemPrecoInput = document.getElementById("item-preco");
        const itemQtdInput = document.getElementById("item-qtd");
        const itemDescontoInput = document.getElementById("item-desconto");
        const btnAddItem = document.getElementById("btn-add-item");
        const itensTbody = document.getElementById("itens-tbody");
        const totalSpan = document.getElementById("total-orcamento");
        const descontoTotalInput = document.getElementById("desconto");

        // Função para corrigir os índices
        function renumerarIndices() {
            const linhas = itensTbody.querySelectorAll("tr");
            linhas.forEach((tr, index) => {
                const inputs = tr.querySelectorAll('input[type="hidden"]');
                inputs.forEach(input => {
                    const name = input.getAttribute("name");
                    // Procura por itens[numero] e substitui pelo índice correto
                    const newName = name.replace(/itens\[\d+\]/, `itens[${index}]`);
                    input.setAttribute("name", newName);
                });
            });
        }

        if(produtoSelect) {
            produtoSelect.addEventListener("change", () => {
                const selectedOption = produtoSelect.options[produtoSelect.selectedIndex];
                if (!selectedOption.value) {
                    itemPrecoInput.value = "";
                    itemPrecoInput.readOnly = true;
                    return;
                }
                const preco = selectedOption.getAttribute("data-preco");
                const editavel = selectedOption.getAttribute("data-editavel") === "true";

                itemPrecoInput.value = preco;
                itemPrecoInput.readOnly = !editavel;
            });
        }

        if(btnAddItem) {
            btnAddItem.addEventListener("click", () => {
                const selectedOption = produtoSelect.options[produtoSelect.selectedIndex];
                const produtoId = selectedOption.value;
                const produtoDesc = selectedOption.text;

                if (!produtoId) {
                    alert("Selecione um produto.");
                    return;
                }

                const precoUnit = parseFloat(itemPrecoInput.value);
                const qtd = parseInt(itemQtdInput.value);
                const descItem = parseFloat(itemDescontoInput.value) || 0.0;
                const subtotal = (precoUnit * qtd) - descItem;

                const tr = document.createElement("tr");

                // CORREÇÃO AQUI: Mudei de itens[x] para itens[0]
                // Isso permite que a função 'renumerarIndices' encontre o padrão e corrija.
                tr.innerHTML = `
                <td>${produtoDesc}</td>
                <td>R$ ${precoUnit.toFixed(2)}</td>
                <td>${qtd}</td>
                <td>R$ ${descItem.toFixed(2)}</td>
                <td>R$ ${subtotal.toFixed(2)}</td>
                <td>
                    <button type="button" class="btn-remover">Remover</button>
                    <input type="hidden" name="itens[0].produtoId" value="${produtoId}" />
                    <input type="hidden" name="itens[0].precoUnitario" value="${precoUnit}" />
                    <input type="hidden" name="itens[0].qtd" value="${qtd}" />
                    <input type="hidden" name="itens[0].desconto" value="${descItem}" />
                    <input type="hidden" name="itens[0].produtoDescricaoAux" value="${produtoDesc}" />
                </td>
            `;

                itensTbody.appendChild(tr);

                resetAddPanel();
                renumerarIndices(); // Agora ele vai trocar o [0] pelo índice correto (0, 1, 2...)
                calcularTotalGeral();
            });
        }

        if(itensTbody) {
            itensTbody.addEventListener("click", (e) => {
                if (e.target.classList.contains("btn-remover")) {
                    const tr = e.target.closest("tr");
                    tr.remove();
                    renumerarIndices();
                    calcularTotalGeral();
                }
            });
        }

        if(descontoTotalInput) {
            descontoTotalInput.addEventListener("input", calcularTotalGeral);
        }

        function calcularTotalGeral() {
            let subtotalGeral = 0;
            const todosPrecos = document.querySelectorAll(`input[name$=".precoUnitario"]`);
            const todasQtds = document.querySelectorAll(`input[name$=".qtd"]`);
            const todosDescs = document.querySelectorAll(`input[name$=".desconto"]`);

            for(let i = 0; i < todosPrecos.length; i++) {
                const preco = parseFloat(todosPrecos[i].value);
                const qtd = parseInt(todasQtds[i].value);
                const desc = parseFloat(todosDescs[i].value) || 0;
                subtotalGeral += (preco * qtd) - desc;
            }

            const descontoTotal = parseFloat(descontoTotalInput ? descontoTotalInput.value : 0) || 0;
            const totalFinal = subtotalGeral - descontoTotal;

            if(totalSpan) totalSpan.textContent = `R$ ${totalFinal.toFixed(2)}`;
        }

        function resetAddPanel() {
            produtoSelect.selectedIndex = 0;
            itemPrecoInput.value = "";
            itemPrecoInput.readOnly = true;
            itemQtdInput.value = "1";
            itemDescontoInput.value = "0";
        }

        calcularTotalGeral();
    });
    /*]]>*/
</script>
</body>
</html>